---
author: aeddi
title: "Berty, Libp2p и Bluetooth Low Energy"
date: 2020-04-08
image: "2020-04-06-Berty-blogpost-Bluetooth-Low-Energy.jpg"
categories:
  - announcement
tags:
  - bluetooth
  - technical
  - open-source
  - ipfs
---

# Berty, Libp2p и Bluetooth Low Energy

Как вы, вероятно, знаете, мы разрабатываем Berty, приложение для однорангового обмена сообщениями без регулирующих органов и без сбора метаданных. Оно направлено на сохранение анонимности и конфиденциальности пользователей.

Одна из функций, которая, по нашему мнению, важна для приложения однорангового обмена сообщениями, достойного такого названия, - это возможность напрямую связываться между устройствами (автономная связь без доступа в Интернет).

Так что да, потому что мы уверены, что большинство (все?) из вас заинтересованы в этом варианте использования, с Berty у вас будет возможность пообщаться с друзьями посреди пустыни Сахара! :tada:

Шутки в сторону, чтобы отметить тот факт, что скоро будет выпущен наш первый транспорт, позволяющий прямые соединения между устройствами (:champagne:), давайте проследим долгую хронологию нашей работы над разработкой этой функции.

## Назад в 2018: Рождение проекта Berty

![Назад в будущее gif](rkbQMNjvI.gif)

В то время, примерно после месяца исследований, разделенных на две команды, одна группа тестировала сетевые технологии одноранговой сети, а другая экспериментировала с технологиями прямого транспорта - точнее, Apple MultipeerConnectivity - мы договорились о реализации следующего стека для нашего чата:

- [React Native](https://reactnative.dev/) UI.
- Монолитный блок [gomobile](https://github.com/golang/go/wiki/Mobile), включающий пользовательский [go-libp2p](https://docs.libp2p.io/introduction/), всё управление криптографией и интеллектуальный чат (база данных, управление контактами, отправка/получение событий и т. д.).
- Два встроенных драйвера[Bluetooth Low Energy](https://en.wikipedia.org/wiki/Bluetooth_Low_Energy) для Android и iOS, привязанные к транспорту libp2p, чтобы обеспечить связь без доступа в Интернет.

Поэтому мы быстро распределили задачи между разными членами команды в соответствии с их интересами, засучили рукава и приступили к серьезной работе.

## Bluetooth Low что?

Хорошо, для начала давайте вспомним, что такое Bluetooth Low Energy.

Bluetooth - это стандарт беспроводной технологии для обмена данными между электронными устройствами на небольшом расстоянии. Проще говоря, мы можем сказать, что существует два варианта, два разных стандарта: Bluetooth Classic (BR/EDR) и Bluetooth Low Energy (BLE).

Bluetooth Classic предназначен для соединения одного ведущего устройства с семью ведомыми устройствами. Наиболее актуальный вариант использования этой технологии - подключение к компьютеру гарнитуры, клавиатуры и мыши. В этом случае от пользователя требуется предварительное сопряжение.

Bluetooth Low Energy, как следует из названия, более энергоэффективен, недостатком является то, что он предлагает гораздо меньшую пропускную способность (например: невозможно передавать звук на наушники через BLE). Два основных преимущества этой технологии в контексте приложения для обмена сообщениями:

- Устройства могут одновременно действовать как ведущие и ведомые, что очень удобно для одноранговой сети. Прежде всего, в стандарте не определено максимальное количество одновременных подключений. Таким образом, только аппаратная (чип) и программная (ОС/драйвер) реализации устройства могут ограничивать количество одновременных участников в разговоре по BLE.
- Это не требует предварительного сопряжения. Два пользователя могут просто открыть свое приложение и начать общение без дополнительных настроек.

Зная это, мы, естественно, решили выбрать эту технологию для разработки нашего первого однорангового транспорта.


## Драйвер BLE для go-libp2p: НИОКР

### Первый прототип на Darwin: "EZ WIN"

В начале осени 2018 года мы доверили одному из членов нашей команды внедрение транспорта libp2p BLE.

API-интерфейсы, предоставленные Apple для iOS и macOS (Darwin), были очень просты в использовании, поэтому мы решили начать с этой платформы и смогли написать надежный транспорт для [go-libp2p](https://docs.libp2p.io/tutorials/getting-started/go/) и собственный драйвер BLE. в течение нескольких недель.

Гордясь результатом, мы были уверены, что перенос этой функции на Android пройдет гладко. Через несколько недель мы уже видели себя с работающим драйвером и планировали расслабиться в шезлонге и попить коктейль.

Так всегда бывает, когда вы занимаетесь Ниокр в области технологий, не так ли?

### Первый прототип на Android: что может пойти не так?

![Это ловушка!](giphy.gif)

#### Давайте попробуем

В ноябре 2018 года мы начали реализацию версии драйвера BLE для Android и после нескольких недель неплодотворной разработки мы поняли, что работа оказалась более сложной, чем мы думали (гораздо сложнее).

Действительно, API-интерфейсы для BLE на Android гораздо более подвержены ошибкам для разработчиков, которые плохо знакомы с их использованием. Они оба более гибкие, но и гораздо более сложные, чем на Darwin. Они предлагают меньшую абстракцию, особенно в отношении параллелизма операций, ассоциации устройства с его MAC-адресом, который постоянно меняется (функция безопасности BLE) и т.д.

Вероятно, поэтому в Интернете доступно несколько библиотек, каждая из которых утверждает, что делает разработку BLE на Android «менее болезненной», и, поверьте нашему опыту, если они совместимы с вашими потребностями, мы настоятельно рекомендуем вам их использовать!

- [RxAndroidBle от Polidea](https://github.com/Polidea/RxAndroidBle)
- [Nordic Semiconductor's Lib](https://github.com/NordicSemiconductor/Android-BLE-Library)
- [iDevicesInc от SweetBlue](https://github.com/iDevicesInc/SweetBlue)

К сожалению, мы пришли к выводу, что они не соответствуют нашим специфическим потребностям, поэтому решили продолжить разработку напрямую с использованием Android API.

Нам нужно было приложить больше усилий, может быть, добавить еще одного разработчика из нашей команды по этой теме?

#### А вот и новый претендент

![Новый претендент](SkVml4jPI.jpg)

Мы решили добавить второго разработчика по этому поводу. Чтобы погрузиться в ход вещей, делая что-то полезное, он начал с создания документации по нашему BLE-драйверу для нашей команды.

За несколько дней он быстро разработал простое приложение для Android, основанное на первоначальном прототипе, которое будет вручную создано с помощью API BLE для Java и Android.

Для самых любопытных вы можете взглянуть на этот устаревший документ здесь: [berty-ble-service-v1-doc](https://crpt.fyi/Presentation)

А здесь вы найдете «быстрое и грязное» обучающее приложение: [ble-prototype-v1](https://github.com/berty/ble-prototype-v1)

Работая вместе над этой темой, через пару недель они смогли настроить альфа-версию драйвера BLE с Android на Android, привязанную к транспорту libp2p! 🎉

Вы можете посмотреть эту старую версию драйвера здесь: [berty/v1/ble/driver](https://github.com/berty/berty/tree/v1/network/transport/ble/driver)

![Настройка BLE dev](r17mW7jv8.jpg) *Четыре Android-смартфона наконец-то обмениваются данными через ble-libp2p-transport*

Сейчас январь 2019 года, и даже если мы довольны заложенным первым кирпичом, у нас все еще есть две основные проблемы, которые необходимо решить:

- На данный момент драйвер работает только между устройствами Android, несколько тестов, которые мы провели между Android и iOS, позволили нам понять масштабы предстоящей работы по настройке и улучшению.
- Эта предварительная версия работает, но остается очень нестабильной. Иногда соединения выходят из строя, иногда они работают мгновенно, иногда они остаются стабильными в течение нескольких часов, иногда они отключаются через несколько секунд, и все это без того, чтобы мы могли определить причины.

Зная, что в нашем случае безопасного чат-приложения, построенного на основе libp2p, использование транспорта BLE особенно значительно, за исключением того, что технология спроектирована так, чтобы быть энергоэффективной, а недостатком является её низкая производительность.

Не найдя в официальной документации ответа о наших проблемах нестабильности, мы поискали в Интернете и нашли много статей о ненадежных соединениях BLE на Android и способах их решения.

Вы можете ознакомиться с наиболее актуальными статьями здесь:

- [Как заставить Android BLE работать - Martijn van Welie](https://medium.com/@martijn.van.welie/making-android-ble-work-part-3-117d3a8aee23)
- [BLE в Android - Stefan](https://stefanbossbaly.com/2018/08/06/ble-in-android)
- [Краткий рассказ о тайм-аутах соединения Android BLE и внутренних ошибках GATT - Andreas Schweizer](https://blog.classycode.com/a-short-story-about-android-ble-connection-timeouts-and-gatt-internal-errors-fa89e3f6a456)
- [4 совета, как заставить Android BLE действительно работать - Chee Yi Ong](https://punchthrough.com/android-ble-development-tips)


![Пример кода](HydFvfow8.png) *Пример кода из одной из лучших доступных библиотек "сделать BLE на Android менее болезненным"*

Основная информация, которую мы извлекли из этого исследования, заключается в том, что существуют проблемы состояния соединения, которые могут возникать на низком уровне, которые напрямую не обрабатываются API-интерфейсами Android, поэтому разработчик должен решить их (без какой-либо документации, чтобы помочь им).

На данный момент мы предполагаем, что нашим двум разработчикам потребуется еще пара месяцев, чтобы заново спроектировать весь код, протестировать, улучшить и починить его для Android - Android, прежде чем перейти на iOS - Android.

#### Дилемма "дорожной карты"

![Daily Struggle - Two buttons](H1c6Dm9vU.jpg)

Двое наших разработчиков - примерно треть нашей небольшой команды - уже довольно долгое время постоянно работают над драйвером Android.

Из-за того, что мы отстаем от нашей "дорожной карты", мы изначально планировали выпустить MVP через несколько месяцев, и наша кодовая база могла бы использовать хороший сеанс рефакторинга.

Поскольку наша альфа-версия драйвера BLE для Darwin работает, мы решили отложить работу над драйвером для Android на более поздний срок - чтобы упростить задачу: когда у нас будет время.

## IPFS Camp 🇪🇸

Связанное сообщение в блоге:

Команда Berty в IPFS Camp, июнь 2019 г.</p> 

Поскольку мы были преданными последователями технологии P2P, для нас было важно принять участие в [IPFS Camp](https://camp.ipfs.io/), организованном людьми, стоящими за [IPFS](https://ipfs.io/) в Барселоне в конце июня 2019 г.

Команда Protocol Labs попросила участников предложить молниеносные переговоры по темам, связанным с IPFS и одноранговой связью. Мы предложили несколько, но организаторы выбрали BLE.

Несмотря на постоянную спешку с MVP в чате, мы быстро подготовили доклад, демонстрацию транспорта libp2p через BLE и очистку кода встроенного драйвера iOS.

Делая демонстрацию и разговаривая с людьми, мы почувствовали, что прямой транспорт заинтересовал многих людей в сообществе IPFS.

* 👉 [Слайды обсуждения](https://github.com/ipfs/camp/blob/master/LIGHTNING_TALKS/ipfscamp2019-lightningtalk-bluetoothle.pdf) (PDF)
* 👉 [Видео обсуждения](https://www.youtube.com/watch?reload=9&v=aaSFHxpwm9A)



## Середина 2019: полный рефакторинг "дорожной карты"

![Refracto everything](B1_hcXoDL.gif)



### "Состояние игры"

Наряду с нашим желанием быстро поработать над этими темами, чтобы предоставить сообществу удобный прямой транспорт, мы знали о нескольких вещах:

- Для того, чтобы транспорт работал на Android и iOS, разработчикам, очевидно, необходимо сначала подключить этот драйвер к узлу IPFS. До сих пор мы использовали настраиваемую сеть go-libp2p, но если мы хотим, чтобы сообщество получило пользу от нашей работы, нам нужно сделать её более общей.
- Замена нашей сети первой версии на полный узел IPFS - непростая задача. Мы также поняли, что архитектура нашей первой версии приложения не так хороша, как должна быть. Принимая во внимание все, что мы узнали во время разработки этой первой версии, было бы быстрее и проще начать с нуля, чем пытаться исправить нашу текущую кодовую базу.
- Преимущество BLE в том, что он совместим с разными платформами, но он очень медленный. Он может подходить для отправки небольших текстовых сообщений, но совершенно не подходит для обмена фотографиями, не говоря уже о видео. Однако есть альтернативы. Мы рассмотрим этот момент ниже.
- Помимо создания общего сетевого уровня, мы также можем сделать общий уровень выше (тот, который подключает уровень чата к сети, выполняя все криптографические операции).



### План

После нескольких дней обдумывания ситуации мы, наконец, решили отказаться от версии 1 и начать работу над версией 2 со следующей "дорожной картой":

- Когда большинство пунктов, перечисленных ниже, будут реализованы (по нашей оценке, в начале 2020 года), мы снова начнем работать над прямым транспортом.
- Больше никаких кастомных сетей go-libp2p! Мы будем работать над [gomobile-ipfs](https://github.com/ipfs-shipyard/gomobile-ipfs) общей библиотекой для запуска полного узла IPFS на мобильных устройствах. Таким образом, сообщество получит пользу от нашей работы, и мы сможем извлечь выгоду из их вклада, чтобы оптимизировать и адаптировать эту библиотеку к конкретным потребностям мобильных платформ.
- Мы реализуем порт golang с открытым исходным кодом для [Orbit-DB](https://orbitdb.org/) с именем [go-orbit-db](https://github.com/berty/go-orbit-db). Эта распределенная база данных через IPFS будет использоваться для синхронизации, хранения и упорядочивания наших сообщений.
- Мы полностью переработаем ядро приложения, задокументируем его и сделаем универсальным. Этот уровень будет построен поверх go-orbit-db и возьмет на себя все криптографические операции. Мы упакуем всё в удобный SDK под названием [Протокол Berty](https://github.com/berty/berty) и предоставим его разработчикам, желающим разрабатывать безопасные распределённые приложения.
- И вдобавок к этому, очевидно, мы реализуем мессенджер Berty с использованием протокола Berty.

![Стэк Berty](rkyZNGsP8.png)

* 👉 [Протокол Berty: Нетехническая презентация](https://www.youtube.com/watch?v=fnl7Omsbpbw) (доступны английские субтитры)
* 👉 [Протокол Berty: Техническая презентация](https://www.youtube.com/watch?v=jtAtIsyUn0A) (доступны английские субтитры)
* 👉 [Документация протокола Berty ](https://berty.tech/docs/protocol)
* 👉 [Репозиторий протокола Berty](https://github.com/berty/berty)



## Начало 2020: Как дела?

![Соник ждёт](HkQ7J7iD8.gif)

Итак, пришло время! Но поскольку вся наша команда все еще активно работает над различными частями стека, мы наняли нового разработчика, который полностью отвечает за реализацию прямого транспорта.

По нашей традиции, он начал с разработки тестового приложения на Android, чтобы получить его в свои руки. Для любопытных: [ble-prototype-v2](https://github.com/berty/ble-prototype-v2)

Поскольку BLE не подходит для отправки большого контента и нам нужно начинать реализацию драйверов с нуля, мы думали о том, чтобы начать с реализации более эффективных первых альтернатив.



> *Какие? И почему "первые", если они эффективнее?*

Apple Multipeer Connectivity (AirDrop) и Android Nearby - это две технологии, основанные на одном принципе: два одноранговых узла обнаруживают друг друга и устанавливают свое соединение с помощью BLE. Затем, когда все становится серьезным, они устанавливают прямое соединение Wi-Fi (без маршрутизатора), чтобы продолжить диалог в оптимальных условиях. Как вы понимаете, связь между одноранговыми узлами не только надежнее, но и намного быстрее. Это позваляет обмениваться большими файлами с пропускной способностью, предлагаемой Wi-Fi, и, вдобавок ко всему, их API предлагает гораздо больше абстракции, а драйверы будет намного проще реализовать.



> *Хорошо. Отлично! Но какой смысл в этом случае реализовывать драйвер BLE?*

У этих двух технологий есть и обратная сторона: они несовместимы. Это означает, что Apple Mutlipeer Connectivity будет работать только на устройствах Darwin, а Android Nearby будет работать только на устройствах Android.

И поскольку иногда может случиться (мы обещаем, что это возможно), что два человека могут быть друзьями, несмотря на то, что они не используют устройства одной и той же марки, мы планируем зарезервировать использование драйвера BLE для создания универсального моста между платформы: Android и Darwin... и почему даже не Linux и Windows, если сообщество нам немного поможет. :wink:



> *Хорошо, это план! Разве вы не говорили нам в начале статьи, что собираетесь что-то выпустить?*

![Алиса ждёт](giphy2.gif)

Ух, мы сделали! 😎



### Наш прогноз:

- **Многопользовательская связь:** Выполняется реализация! Думаем и надеемся, что в течение месяца он будет готов и доступен в gomobile-ipfs! :tada:
- **Android Nearby:** Через один или два месяца после выпуска драйвера многопользовательской связи.
- **BLE для Android и iOS:** Дата и продолжительность не определены, но это будет третий шаг.
- **BLE для Linux и Windows:** Вероятно, самым мудрым решением было бы подождать, пока будут реализованы эталонные версии драйверов (iOS и Android), но если сообщество слишком нетерпеливо, чтобы ждать, пока мы поработаем над ним, мы не будем стоять на его пути. :smirk:

Для любопытных (которые определенно очень любопытны) наш новый разработчик также разработал тестовое приложение для многопользовательского соединения: [multipeer-connectivity-prototype](https://github.com/berty/multipeer-connectivity-prototype)

В наушниках мне сказали 👨‍💼, что пока я пишу эту статью, он только что успешно подключил свой прототип к первой версии Berty! Вот [ссылка](https://github.com/berty/berty/pull/1832#issuecomment-610859687). Итак, все, что нам нужно сделать сейчас, это настроить его и интегрировать в gomobile-ipfs.

Если вы хотите протянуть руку помощи, мы будем рады получить её в нашем [сообществе](https://berty.tech/community)! [![Внести вклад](r1VGRZsv8.gif)](https://berty.tech/contribute)
